# NetStress Titanium - Automated Binary Release
# Builds and releases pre-compiled binaries for Linux and Windows
# Users can download and run without installing Rust/Python/BPF toolchains

name: Build and Release Binaries

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag (e.g., v3.0.1)"
        required: true
        default: "v3.0.0"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-linux:
    name: Build Linux x86_64
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libssl-dev \
            libclang-dev \
            llvm-dev \
            libbpf-dev \
            linux-headers-$(uname -r) \
            musl-tools \
            patchelf

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: x86_64-unknown-linux-gnu, x86_64-unknown-linux-musl

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin pyoxidizer
          pip install -r requirements.txt

      - name: Build Native Rust Engine
        working-directory: native/rust_engine
        run: |
          cargo build --release
          maturin build --release

      - name: Install Native Engine Wheel
        run: |
          pip install native/rust_engine/target/wheels/*.whl --force-reinstall

      - name: Build Single Binary with PyOxidizer
        run: |
          pyoxidizer build --release

      - name: Package Linux Binary
        run: |
          mkdir -p dist/linux
          cp build/*/release/install/netstress dist/linux/netstress-linux-x86_64 || \
          cp build/*/release/*/netstress dist/linux/netstress-linux-x86_64 || \
          echo "Binary location may vary"
          chmod +x dist/linux/netstress-linux-x86_64

          # Create tarball with docs
          cd dist/linux
          tar -czvf netstress-linux-x86_64.tar.gz \
            netstress-linux-x86_64 \
            ../../README.md \
            ../../docs/CLI_USAGE.md \
            ../../docs/CAPABILITIES.md

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: netstress-linux-x86_64
          path: dist/linux/netstress-linux-x86_64.tar.gz
          retention-days: 30

  build-windows:
    name: Build Windows x64
    runs-on: windows-2022

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: dtolnay/rust-action@stable
        with:
          toolchain: stable
          targets: x86_64-pc-windows-msvc

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install maturin pyoxidizer
          pip install -r requirements.txt

      - name: Build Native Rust Engine
        working-directory: native/rust_engine
        run: |
          cargo build --release
          maturin build --release

      - name: Install Native Engine Wheel
        run: |
          $wheel = Get-ChildItem -Path "native/rust_engine/target/wheels/*.whl" | Select-Object -First 1
          pip install $wheel.FullName --force-reinstall

      - name: Build Single Binary with PyOxidizer
        run: |
          pyoxidizer build --release

      - name: Package Windows Binary
        run: |
          New-Item -ItemType Directory -Force -Path dist/windows

          # Find and copy the executable
          $exe = Get-ChildItem -Path "build" -Recurse -Filter "netstress.exe" | Select-Object -First 1
          if ($exe) {
            Copy-Item $exe.FullName -Destination "dist/windows/netstress-win-amd64.exe"
          }

          # Create zip with docs
          Compress-Archive -Path @(
            "dist/windows/netstress-win-amd64.exe",
            "README.md",
            "docs/CLI_USAGE.md",
            "docs/CAPABILITIES.md"
          ) -DestinationPath "dist/windows/netstress-win-amd64.zip"

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: netstress-win-amd64
          path: dist/windows/netstress-win-amd64.zip
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: netstress-linux-x86_64
          path: artifacts/

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: netstress-win-amd64
          path: artifacts/

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate Checksums
        run: |
          cd artifacts
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: NetStress Titanium ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          body: |
            ## NetStress Titanium ${{ steps.version.outputs.version }}

            **Military-Grade Network Stress Testing Framework**

            ### Downloads

            | Platform | File | Description |
            |----------|------|-------------|
            | Linux x86_64 | `netstress-linux-x86_64.tar.gz` | Single binary for Linux |
            | Windows x64 | `netstress-win-amd64.zip` | Single executable for Windows |

            ### Quick Start

            **Linux:**
            ```bash
            tar -xzf netstress-linux-x86_64.tar.gz
            chmod +x netstress-linux-x86_64
            ./netstress-linux-x86_64 --help
            ```

            **Windows:**
            ```powershell
            Expand-Archive netstress-win-amd64.zip
            .\netstress-win-amd64.exe --help
            ```

            ### Features
            - ✅ Native Rust engine compiled in
            - ✅ No Python/Rust installation required
            - ✅ GPU acceleration (if CUDA available)
            - ✅ Kill Chain automation
            - ✅ AI-powered optimization

            ### Checksums
            See `SHA256SUMS.txt` for file integrity verification.

          files: |
            artifacts/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
